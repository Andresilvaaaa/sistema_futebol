name: Deploy futebol System

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_BACKEND: ${{ github.repository_owner }}/sistema-futebol-backend
  IMAGE_FRONTEND: ${{ github.repository_owner }}/sistema-futebol-frontend

jobs:
  build-and-deploy:
    name: ðŸš€ Build & Deploy
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¦ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”§ Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: ðŸ› ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ” Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ”¤ Normalize owner to lowercase for GHCR tags
        shell: bash
        run: |
          OWNER_LC="${GITHUB_REPOSITORY_OWNER,,}"
          echo "OWNER_LC=$OWNER_LC" >> $GITHUB_ENV
          echo "IMAGE_BACKEND=$OWNER_LC/sistema-futebol-backend" >> $GITHUB_ENV
          echo "IMAGE_FRONTEND=$OWNER_LC/sistema-futebol-frontend" >> $GITHUB_ENV

      - name: ðŸ Build & Push Backend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: backend/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_BACKEND }}:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_BACKEND }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: âš›ï¸ Build & Push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: frontend/Dockerfile
          push: true
          build-args: |
            NEXT_PUBLIC_API_URL=http://backend:5000
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_FRONTEND }}:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_FRONTEND }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ðŸ”‘ Prepare SSH key (Debug only)
        shell: bash
        run: |
          echo "ðŸ” Verificando secret VPS_SSH_KEY..."
          echo "Tamanho do secret: $(echo '${{ secrets.VPS_SSH_KEY }}' | wc -c) caracteres"
          echo "Primeiros 50 caracteres: $(echo '${{ secrets.VPS_SSH_KEY }}' | head -c 50)"

      - name: ðŸ“¡ Deploy to VPS
        uses: appleboy/ssh-action@master
        env:
          PROD_DATABASE_URL: ${{ secrets.PROD_DATABASE_URL }}
          PROD_SECRET_KEY: ${{ secrets.PROD_SECRET_KEY }}
          PROD_JWT_SECRET_KEY: ${{ secrets.PROD_JWT_SECRET_KEY }}
          PROD_CORS_ORIGINS: ${{ secrets.PROD_CORS_ORIGINS }}
        with:
          host: ${{ secrets.VPS_HOST }}
          port: ${{ secrets.VPS_PORT }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          debug: true
          envs: PROD_DATABASE_URL,PROD_SECRET_KEY,PROD_JWT_SECRET_KEY,PROD_CORS_ORIGINS,GITHUB_REPOSITORY
          command_timeout: 30m
          script: |
            set -e
            echo "âœ… Deploy iniciado!"
            echo "ðŸ“ Servidor: $(hostname)"
            echo "ðŸ‘¤ UsuÃ¡rio: $(whoami)"

            # Verificar Docker
            docker --version
            docker compose version

            # Criar diretÃ³rio do projeto (usa nome do repo)
            mkdir -p ~/sistema_futebol
            cd ~/sistema_futebol

            # Clone ou atualize repositÃ³rio
            if [ -d ".git" ]; then
              echo "ðŸ“‚ Atualizando repositÃ³rio..."
              git fetch --all
              git reset --hard origin/main
            else
              echo "ðŸ“¥ Clonando repositÃ³rio..."
              git clone https://github.com/${GITHUB_REPOSITORY}.git .
            fi

            # Criar/atualizar .env para docker compose (variÃ¡veis de produÃ§Ã£o)
            echo "ðŸ” Atualizando .env..."
            cat > .env <<EOF
            DATABASE_URL=${PROD_DATABASE_URL}
            SECRET_KEY=${PROD_SECRET_KEY}
            JWT_SECRET_KEY=${PROD_JWT_SECRET_KEY}
            CORS_ORIGINS=${PROD_CORS_ORIGINS}
            EOF

            # Verificar se os Dockerfiles existem e subir com build
            if [ -f "docker-compose.yml" ]; then
              echo "ðŸ³ Docker Compose encontrado!"
              # Parar containers antigos
              docker compose down || true
              # Construir e iniciar containers
              docker compose up -d --build
              # Verificar status
              docker compose ps
            else
              echo "âš ï¸ docker-compose.yml nÃ£o encontrado"
              echo "ðŸ“ Estrutura do projeto:"
              ls -la
            fi

            echo "ðŸŽ‰ Deploy concluÃ­do!"
            echo "ðŸ“… $(date)"